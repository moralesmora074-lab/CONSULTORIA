<script>
        // --- 1. CONFIGURACI√ìN SUPABASE (No tocar) ---
        const supabaseUrl = 'https://zmpshzskqrkqjohdqliz.supabase.co';
        const supabaseKey = 'sb_publishable_S-o2vtqOhOkKhgH318MaEQ_Ynh9mOdd';
        const cliente = supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. FUNCI√ìN CONTACTO (Formulario) ---
        async function enviar(e) {
            e.preventDefault();
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.innerText = "Enviando...";
            status.innerText = "";

            const datos = {
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                mensaje: document.getElementById('mensaje').value
            };

            // Intento de env√≠o a Supabase
            let { error } = await cliente.from('contactos').insert([datos]);

            // Reintento si falla por may√∫sculas/min√∫sculas en la tabla
            if (error) {
                console.log("Reintentando con may√∫scula...");
                const intento2 = await cliente.from('CONTACTOS').insert([datos]);
                error = intento2.error;
            }

            if (error) {
                status.style.color = 'red';
                status.innerText = "Error: " + error.message;
                btn.disabled = false;
                btn.innerText = "Reintentar";
            } else {
                status.style.color = 'green';
                status.innerText = "‚úÖ ¬°ENVIADO CON √âXITO!";
                document.getElementById('miForm').reset();
                btn.innerText = "ENVIADO";
                setTimeout(() => { btn.disabled = false; btn.innerText = "ENVIAR CONSULTA"; }, 3000);
            }
        }

        // --- 3. L√ìGICA DEL CHATBOT (MEJORADA) ---
        function toggleChat() {
            const chat = document.getElementById('chatWindow');
            chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        
        function sendMessage() {
            const input = document.getElementById('userInput');
            const txt = input.value.toLowerCase().trim(); // Convertimos a min√∫sculas para comparar f√°cil
            
            if(!txt) return;

            // 1. Agregamos el mensaje del usuario
            addMsg(input.value, 'user');
            input.value = '';

            // 2. Simulamos "pensando..." con un peque√±o retraso
            setTimeout(() => {
                let resp = "Para una atenci√≥n personalizada y detallada, escr√≠benos al WhatsApp +51 981 140 470.";

                // --- L√ìGICA DE PREGUNTAS Y RESPUESTAS ---

                // Saludo b√°sico
                if(txt.includes('hola') || txt.includes('buenas')) {
                    resp = "¬°Hola! üëã Soy el asistente virtual de CPRO. Preg√∫ntame sobre precios, servicios o dudas contables comunes.";
                }
                
                // Precios
                else if(txt.includes('precio') || txt.includes('costo') || txt.includes('cobran')) {
                    resp = "Nuestros planes contables inician desde **S/ 350 al mes** para el R√©gimen MYPE Tributario. ¬øTe gustar√≠a una cotizaci√≥n exacta?";
                }

                // Servicios
                else if(txt.includes('servicio') || txt.includes('hacen')) {
                    resp = "Ofrecemos Contabilidad General, Declaraciones SUNAT mensuales/anuales, Asesor√≠a Laboral y Financiera.";
                }

                // PREGUNTA 1: Libros Contables Obligatorios
                else if(txt.includes('libros') && (txt.includes('obligatorio') || txt.includes('cuales'))) {
                    resp = "Depende de tu r√©gimen. En el **RER y MYPE** es obligatorio el Registro de Compras y Ventas. En el **R√©gimen General**, se a√±aden el Libro Diario y Mayor. ¬°Nosotros los gestionamos por ti!";
                }

                // PREGUNTA 2: Frecuencia de actualizaci√≥n
                else if(txt.includes('frecuencia') || txt.includes('cada cuanto') || txt.includes('actualizar') || txt.includes('plazo')) {
                    resp = "Los Libros Electr√≥nicos (PLE) se deben enviar **mensualmente** seg√∫n el cronograma de vencimientos de SUNAT (basado en el √∫ltimo d√≠gito de tu RUC).";
                }

                // PREGUNTA 3: Consecuencias / Multas
                else if(txt.includes('pasa si') || txt.includes('no llevo') || txt.includes('multa') || txt.includes('sancion')) {
                    resp = "‚ö†Ô∏è Riesgo alto: SUNAT puede imponerte **multas (UITs)**, cerrar temporalmente tu negocio y realizar fiscalizaciones profundas. Es mejor prevenir y estar al d√≠a.";
                }

                // Despedida
                else if(txt.includes('gracias') || txt.includes('chau')) {
                    resp = "¬°De nada! Estamos aqu√≠ para ayudarte a crecer. üöÄ";
                }

                addMsg(resp, 'bot');
            }, 600);
        }

        function addMsg(txt, type) {
            const body = document.getElementById('chatBody');
            // Convertimos **texto** en negrita simple para que se vea mejor
            const formattedTxt = txt.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            body.innerHTML += `<div class="msg ${type}">${formattedTxt}</div>`;
            body.scrollTop = body.scrollHeight;
        }
    </script>
